name: Integration - run awenctl

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-awenctl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Rust cargo registry + target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Install clippy & rustfmt
        run: |
          rustup component add clippy --toolchain stable || true
          rustup component add rustfmt --toolchain stable || true

      - name: Cargo fmt check
        working-directory: ./awen-runtime
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        working-directory: ./awen-runtime
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests
        working-directory: ./awen-runtime
        run: cargo test --all --no-fail-fast

      - name: Build release
        working-directory: ./awen-runtime
        run: cargo build --workspace --release

      - name: Run awenctl with example IR
        working-directory: ./awen-runtime
        run: |
          ./target/release/awenctl run example_ir.json --seed 42

      - name: Verify run artifacts contain results.json and ir.json
        working-directory: ./awen-runtime
        run: |
          set -e
          DIR=$(ls -d awen_run_* | tail -n1)
          echo "Checking directory $DIR"
          python3 - <<'PY'
import json, pathlib
dirs=list(pathlib.Path('.').glob('awen_run_*'))
assert dirs, 'no awen_run_* dirs found'
latest=sorted(dirs, key=lambda p: p.stat().st_mtime)[-1]
res=latest/'results.json'
ir=latest/'ir.json'
assert res.exists(), f'{res} missing'
assert ir.exists(), f'{ir} missing'
data=json.loads(res.read_text())
assert 'node_results' in data, 'results.json missing node_results'
print('run artifacts OK')
PY

      - name: List generated artifacts
        run: ls -la awen_run_*
